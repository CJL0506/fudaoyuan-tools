<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¾…å¯¼å‘˜è°ˆè¯è®°å½•ç”Ÿæˆå™¨ (é™ˆä½³å‡Œæœ€ç»ˆå†³ç­–ç‰ˆ)</title>
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: "Segoe UI", "Microsoft YaHei", sans-serif; background-color: #f0f4f8; padding: 20px; display: flex; justify-content: center; }
        .container { background: white; padding: 40px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); width: 900px; max-width: 100%; }
        h1 { color: #2d3748; text-align: center; margin-bottom: 30px; font-weight: 700; }
        
        .card { background: #fff; border: 1px solid #e2e8f0; padding: 25px; border-radius: 12px; margin-bottom: 20px; transition: 0.2s; }
        .card:hover { border-color: #cbd5e0; box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
        .card-title { font-weight: 700; margin-bottom: 12px; color: #4a5568; display: block; font-size: 16px; }
        
        .api-input { width: 96%; padding: 12px; border: 1px solid #cbd5e0; border-radius: 8px; font-family: monospace; color: #2d3748; background: #f7fafc; }
        .api-input:focus { border-color: #4299e1; outline: none; background: #fff; }

        .file-upload { position: relative; display: flex; align-items: center; justify-content: center; height: 100px; border: 2px dashed #cbd5e0; border-radius: 12px; background: #f7fafc; cursor: pointer; transition: 0.2s; }
        .file-upload:hover { border-color: #4299e1; background: #ebf8ff; color: #2b6cb0; }
        
        .btn { width: 100%; padding: 16px; background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%); color: white; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 6px rgba(66, 153, 225, 0.3); transition: 0.2s; }
        .btn:disabled { background: #cbd5e0; cursor: not-allowed; box-shadow: none; }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 6px 12px rgba(66, 153, 225, 0.4); }

        .log-area { height: 250px; overflow-y: auto; background: #2d3748; color: #edf2f7; padding: 20px; border-radius: 12px; font-size: 13px; margin-top: 20px; font-family: "Consolas", monospace; line-height: 1.6; }
        .log-entry { margin-bottom: 8px; border-bottom: 1px solid #4a5568; padding-bottom: 4px; }
        .tag { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-left: 5px; font-weight: bold; }
        .tag-role { background: #48bb78; color: white; }
        .tag-topic { background: #ed8936; color: white; }

        .tip { font-size: 13px; color: #718096; margin-top: 8px; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“ å­¦ç”Ÿè°ˆè¯è®°å½•æ™ºèƒ½ç”Ÿæˆå™¨ (é™ˆä½³å‡Œæœ€ç»ˆå†³ç­–ç‰ˆ)</h1>

    <div class="card">
        <span class="card-title">ğŸ”‘ ç¬¬ä¸€æ­¥ï¼šè®¾ç½® DeepSeek API Key</span>
        <input type="password" id="apiKey" class="api-input" placeholder="sk-xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" oninput="saveKey()">
        <div class="tip">Key ä»…ä¿å­˜åœ¨æ‚¨çš„æœ¬åœ°æµè§ˆå™¨ç¼“å­˜ä¸­ï¼Œå®‰å…¨æ— è™ã€‚</div>
    </div>

    <div class="card">
        <span class="card-title">ğŸ“‚ ç¬¬äºŒæ­¥ï¼šä¸Šä¼ å­¦ç”Ÿåå• (Excel)</span>
        <label for="uploadExcel" class="file-upload" id="fileLabel">
            <span>ç‚¹å‡»é€‰æ‹© Excel æ–‡ä»¶ (.xlsx / .xls)</span>
        </label>
        <input type="file" id="uploadExcel" accept=".xlsx, .xls" onchange="handleFileUpload(this)" style="display:none;">
        <div class="tip">
            Excel å¿…å¡«åˆ—ï¼š<code>å§“å</code>ã€<code>ç­çº§</code>ã€<code>å­¦å·</code><br>
            é€‰å¡«åˆ—ï¼š<code>èŒåŠ¡</code> (AIä¼šæ ¹æ®èŒåŠ¡è‡ªåŠ¨è°ƒæ•´äººè®¾)
        </div>
    </div>

    <button id="generateBtn" class="btn" onclick="startProcess()" disabled>ğŸš€ å¼€å§‹ç”Ÿæˆ (ä¿æŒäººè®¾ä¸€è‡´æ€§)</button>

    <div class="log-area" id="logArea">ç­‰å¾…ä»»åŠ¡å¯åŠ¨...</div>
</div>

<script>
    let loadedData = [];
    const API_URL = "https://api.deepseek.com/chat/completions"; 

    // === 1. åŸºç¡€é…ç½®ä¸æœ¬åœ°å­˜å‚¨ ===
    window.onload = function() {
        const savedKey = localStorage.getItem("deepseek_key_v2");
        if(savedKey) document.getElementById("apiKey").value = savedKey;
    }

    function saveKey() {
        const key = document.getElementById("apiKey").value.trim();
        localStorage.setItem("deepseek_key_v2", key);
    }

    // === 2. å·¥å…·å‡½æ•°ï¼šç”Ÿæˆæ—¥æœŸä¸åœ°ç‚¹ ===
    function generateChronologicalDates(count) {
        let dates = [];
        const end = new Date().getTime();
        const start = end - (160 * 24 * 60 * 60 * 1000); // è¿‡å»åŠå¹´
        for (let i = 0; i < count; i++) {
            dates.push(new Date(start + Math.random() * (end - start)));
        }
        return dates.sort((a, b) => a - b).map(d => `${d.getFullYear()}å¹´${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥`);
    }

    function getRandomLocation() {
        const ranges = [{f:1, min:101, max:107}, {f:2, min:201, max:207}, {f:3, min:301, max:307}];
        const r = ranges[Math.floor(Math.random() * ranges.length)];
        const room = Math.floor(Math.random() * (r.max - r.min + 1)) + r.min;
        return `1-${room}`; // æ ¼å¼å¦‚ 1-105
    }

    // === 3. Excel å¤„ç† ===
    function handleFileUpload(input) {
        const file = input.files[0];
        if (!file) return;
        document.getElementById('fileLabel').innerHTML = `âœ… å·²åŠ è½½: <b>${file.name}</b>`;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                loadedData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                if (loadedData.length > 0 && loadedData[0]['å§“å']) {
                    document.getElementById('generateBtn').disabled = false;
                    addLog(`æˆåŠŸè¯»å– ${loadedData.length} åå­¦ç”Ÿæ•°æ®ã€‚`);
                } else { alert("Excel ç¼ºå°‘ 'å§“å' åˆ—ï¼Œè¯·æ£€æŸ¥æ ¼å¼ã€‚"); }
            } catch(err) { alert("æ–‡ä»¶è¯»å–å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚"); }
        };
        reader.readAsArrayBuffer(file);
    }

    function addLog(msg, type="") {
        const div = document.getElementById('logArea');
        let html = `<div class="log-entry">> ${msg}`;
        if(type) html += `<span class="tag tag-role">${type}</span>`;
        html += `</div>`;
        div.innerHTML += html;
        div.scrollTop = div.scrollHeight;
    }

    // === 4. æ ¸å¿ƒé€»è¾‘ï¼šAI ç»Ÿç­¹ç”Ÿæˆ ===
    async function generateStudentRecords(apiKey, student) {
        const name = student['å§“å'];
        const studentClass = student['ç­çº§'] || "æœªçŸ¥ç­çº§";
        const position = student['èŒåŠ¡'] || ""; // ç­é•¿, å›¢æ”¯ä¹¦, æˆ– ç©º
        const count = Math.floor(Math.random() * 5) + 1; // 1-5æ¡è®°å½•
        const dates = generateChronologicalDates(count);
        
        // æ ¸å¿ƒï¼šæ„å»º Promptï¼Œå¼ºåˆ¶é€»è¾‘ä¸€è‡´æ€§
        const prompt = `
        ä½ æ˜¯ä¸€åä¸“ä¸šã€æ¸©æš–çš„é«˜æ ¡è¾…å¯¼å‘˜ã€‚è¯·ä¸ºå­¦ç”Ÿç”Ÿæˆ ${count} ä»½è°ˆè¯è®°å½•ã€‚
        
        ã€å­¦ç”Ÿç”»åƒã€‘
        å§“åï¼š${name}
        ç­çº§ï¼š${studentClass}
        èŒåŠ¡ï¼š${position ? position : "æ— èŒåŠ¡"}
        
        ã€ç”Ÿæˆè¦æ±‚ - æå…¶é‡è¦ã€‘
        1. **äººè®¾ä¸€è‡´æ€§**ï¼šè¯·å…ˆåœ¨å†…å¿ƒä¸ºè¯¥å­¦ç”Ÿè®¾å®šä¸€ä¸ªåˆç†çš„â€œäººè®¾â€ï¼ˆä¾‹å¦‚ï¼šè¸å®ç¨³é‡å‹ã€è¿·èŒ«æ¢ç´¢å‹ã€ç§¯ææ´»è·ƒå‹ï¼‰ã€‚
           - å¦‚æœæœ‰èŒåŠ¡ï¼ˆå¦‚ç­é•¿ï¼‰ï¼Œè¯·è®¾å®šä¸ºè´£ä»»å¿ƒå¼ºã€é…åˆå·¥ä½œçš„ç±»å‹ã€‚
           - æ•´ä¸ªæ—¶é—´çº¿ä¸­ï¼Œå­¦ç”Ÿçš„çŠ¶æ€å˜åŒ–å¿…é¡»ç¬¦åˆé€»è¾‘ã€‚**ç»å¯¹ç¦æ­¢**å‡ºç°å‰åçŸ›ç›¾ï¼ˆä¾‹å¦‚ï¼šä¸è¦å‰ä¸€æ¬¡è°ˆè¯æ˜¯å­¦ä¸šé¢„è­¦ï¼Œåä¸€æ¬¡å°±æ˜¯è·å¾—å›½å¥–ï¼‰ã€‚
        2. **è¯é¢˜é™åˆ¶**ï¼šè°ˆè¯å†…å®¹ä¸»è¦å›´ç»•ä»¥ä¸‹ä¸»é¢˜ï¼ˆéšæœºç»„åˆï¼Œä¸è¦æ¯æ¬¡éƒ½ä¸€æ ·ï¼‰ï¼š
           - **èŒä¸šè§„åˆ’** (è€ƒç ”/å°±ä¸š/è€ƒå…¬çš„è¿·èŒ«ä¸ç¡®å®š)
           - **å¿ƒç†å…³æ€€** (é€‚åº”æ€§ã€äººé™…å…³ç³»ã€æƒ…ç»ªè°ƒèŠ‚)
           - **å‡æœŸå»å‘** (ç¦»æ ¡å®‰å…¨ã€å‡æœŸå®è·µã€ç•™æ ¡å¤ä¹ )
           - **å®¿èˆç”Ÿæ´»** (å®¤å‹å…³ç³»ã€ä½œæ¯ä¹ æƒ¯)
           *æ³¨æ„ï¼šå°½é‡å°‘å†™æç«¯çš„å­¦ä¸šé¢„è­¦ï¼Œé™¤éäººè®¾æ˜¯â€œå­¦å›°ç”Ÿâ€ã€‚å¤šå†™æ¸©å’Œçš„å¼•å¯¼å’Œå…³å¿ƒã€‚*
        3. **å†…å®¹èåˆ**ï¼šè¯·åœ¨è°ˆè¯ä¸­è‡ªç„¶åœ°æåŠä»–æ‰€åœ¨çš„ã€${studentClass}ã€‘æˆ–ã€${position}ã€‘èº«ä»½ã€‚
        4. **æ ¼å¼è¦æ±‚**ï¼š
           - è¿”å› JSON æ•°ç»„ã€‚
           - åŒ…å«å­—æ®µï¼šcontent (50-150å­—ï¼Œç¬¬ä¸‰äººç§°å™è¿°), reflection (30-50å­—ï¼Œè¾…å¯¼å‘˜åæ€)ã€‚
           - ä¸éœ€è¦è¿”å›æ—¥æœŸå’Œåœ°ç‚¹ï¼Œæˆ‘è¿™è¾¹ç”Ÿæˆã€‚

        ã€JSON æ ¼å¼ç¤ºä¾‹ã€‘
        [
          {"content": "...", "reflection": "..."},
          {"content": "...", "reflection": "..."}
        ]
        `;

        try {
            const response = await fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages: [{"role": "user", "content": prompt}],
                    temperature: 1.1 // ç¨å¾®é«˜ä¸€ç‚¹çš„éšæœºæ€§ï¼Œä¿è¯æ¯ä¸ªäººä¸ä¸€æ ·
                })
            });

            if (!response.ok) throw new Error("API Limit");
            
            const json = await response.json();
            // æ¸…ç† markdown æ ‡è®°
            const raw = json.choices[0].message.content.replace(/```json/g, "").replace(/```/g, "").trim();
            const aiResults = JSON.parse(raw);

            // å°† AI å†…å®¹ä¸æˆ‘ä»¬çš„ æ—¶é—´/åœ°ç‚¹ åˆå¹¶
            return aiResults.map((item, index) => ({
                date: dates[index],
                location: getRandomLocation(),
                content: item.content,
                reflection: item.reflection
            }));

        } catch (e) {
            console.error(e);
            addLog(âš ï¸ AI ç”Ÿæˆå¤±è´¥ (${name})ï¼Œä½¿ç”¨å¤‡ç”¨é€»è¾‘ã€‚`);
            // å…œåº•é€»è¾‘
            return dates.map(d => ({
                date: d,
                location: getRandomLocation(),
                content: `è¾…å¯¼å‘˜ä¸${studentClass}çš„${name}è¿›è¡Œäº†è°ˆè¯ã€‚ä¸»è¦æ˜¯äº†è§£å…¶è¿‘æœŸçš„ç”Ÿæ´»çŠ¶æ€å’ŒèŒä¸šè§„åˆ’æƒ³æ³•ã€‚å­¦ç”Ÿè¡¨ç¤ºç›®å‰çŠ¶æ€ç¨³å®šï¼Œ${position ? "ä½œä¸º"+position+"å·¥ä½œè®¤çœŸè´Ÿè´£ã€‚" : "èƒ½å¤Ÿéµå®ˆæ ¡è§„æ ¡çºªã€‚"}`,
                reflection: "è¯¥ç”Ÿæƒ…å†µç¨³å®šï¼Œä¿æŒå…³æ³¨ã€‚"
            }));
        }
    }

    // === 5. Word ç”Ÿæˆä¸æ‰“åŒ… ===
    async function startProcess() {
        const apiKey = document.getElementById('apiKey').value.trim();
        if(!apiKey.startsWith("sk-")) { alert("è¯·å…ˆè¾“å…¥æ­£ç¡®çš„ API Key"); return; }
        
        document.getElementById('generateBtn').disabled = true;
        const zip = new JSZip();
        const { Document, Packer, Paragraph, Table, TableRow, TableCell, WidthType, HeadingLevel, AlignmentType, TextRun } = docx;

        for (let i = 0; i < loadedData.length; i++) {
            const student = loadedData[i];
            const name = student['å§“å'];
            
            addLog(`[${i+1}/${loadedData.length}] æ­£åœ¨åˆ†æå¹¶ç”Ÿæˆï¼š${name}`, student['èŒåŠ¡'] || "æ™®é€šå­¦ç”Ÿ");
            
            // è·å– AI ç”Ÿæˆçš„é€»è¾‘ä¸€è‡´çš„è®°å½•
            const records = await generateStudentRecords(apiKey, student);
            
            // æ„å»º Word
            const docChildren = [];
            
            // æ ‡é¢˜
            docChildren.push(new Paragraph({ 
                text: "å­¦ç”Ÿè¾…å¯¼è®°å½•å†Œ", 
                heading: HeadingLevel.HEADING_1, 
                alignment: AlignmentType.CENTER,
                spacing: { after: 400 }
            }));

            // é¡¶éƒ¨åŸºæœ¬ä¿¡æ¯è¡¨
            docChildren.push(new Table({
                width: { size: 100, type: WidthType.PERCENTAGE },
                rows: [
                    new TableRow({ children: [
                        new TableCell({ children: [new Paragraph({text: "å§“å", bold: true})], width: {size: 15, type: WidthType.PERCENTAGE} }),
                        new TableCell({ children: [new Paragraph(String(name))], width: {size: 35, type: WidthType.PERCENTAGE} }),
                        new TableCell({ children: [new Paragraph({text: "å­¦å·", bold: true})], width: {size: 15, type: WidthType.PERCENTAGE} }),
                        new TableCell({ children: [new Paragraph(String(student['å­¦å·'] || ""))], width: {size: 35, type: WidthType.PERCENTAGE} }),
                    ]}),
                    new TableRow({ children: [
                        new TableCell({ children: [new Paragraph({text: "ç­çº§", bold: true})] }),
                        new TableCell({ children: [new Paragraph(String(student['ç­çº§'] || ""))], width: {size: 35, type: WidthType.PERCENTAGE} }),
                        new TableCell({ children: [new Paragraph({text: "èŒåŠ¡", bold: true})] }),
                        new TableCell({ children: [new Paragraph(String(student['èŒåŠ¡'] || "æ— "))], width: {size: 35, type: WidthType.PERCENTAGE} }),
                    ]}),
                ]
            }));
            
            docChildren.push(new Paragraph({ text: "", spacing: { after: 300 } }));

            // å¾ªç¯è®°å½•
            records.forEach((rec, idx) => {
                if (idx > 0) {
                     docChildren.push(new Paragraph({ 
                        text: "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”", 
                        alignment: AlignmentType.CENTER, 
                        color: "#999999",
                        spacing: { before: 200, after: 200 } 
                    }));
                }

                docChildren.push(new Paragraph({ 
                    text: `ç¬¬ ${idx + 1} æ¬¡è°ˆè¯`, 
                    heading: HeadingLevel.HEADING_3,
                    spacing: { after: 100 }
                }));

                // è®°å½•å¤´ä¿¡æ¯è¡¨ (æ—¶é—´/åœ°ç‚¹)
                docChildren.push(new Table({
                    width: { size: 100, type: WidthType.PERCENTAGE },
                    rows: [
                        new TableRow({ children: [
                            new TableCell({ children: [new Paragraph({text: "è°ˆè¯æ—¥æœŸ", bold: true})], width: {size: 15, type: WidthType.PERCENTAGE} }),
                            new TableCell({ children: [new Paragraph(rec.date)], width: {size: 35, type: WidthType.PERCENTAGE} }),
                            new TableCell({ children: [new Paragraph({text: "è°ˆè¯åœ°ç‚¹", bold: true})], width: {size: 15, type: WidthType.PERCENTAGE} }),
                            new TableCell({ children: [new Paragraph(rec.location)], width: {size: 35, type: WidthType.PERCENTAGE} }),
                        ]})
                    ]
                }));

                // å†…å®¹
                docChildren.push(new Paragraph({ 
                    children: [new TextRun({ text: "ã€è°ˆè¯è¿‡ç¨‹è®°å½•ã€‘", bold: true, color: "#2b6cb0" })],
                    spacing: { before: 150, after: 100 } 
                }));
                docChildren.push(new Paragraph({ text: rec.content, spacing: { line: 260 } }));

                // åæ€ (éšæœºæ˜¾ç¤ºï¼Œè®©æ–‡æ¡£çœ‹èµ·æ¥ä¸é‚£ä¹ˆæœºæ¢°)
                if (Math.random() > 0.3) { 
                    docChildren.push(new Paragraph({ 
                        children: [new TextRun({ text: "ã€è¾…å¯¼å‘˜åæ€ã€‘", bold: true, color: "#c53030" })],
                        spacing: { before: 150, after: 100 } 
                    }));
                    docChildren.push(new Paragraph({ text: rec.reflection, spacing: { line: 260 } }));
                }
                
                docChildren.push(new Paragraph({ text: "", spacing: { after: 200 } }));
            });

            const doc = new Document({ sections: [{ children: docChildren }] });
            const blob = await Packer.toBlob(doc);
            zip.file(`${student['ç­çº§']}_${name}_è®°å½•è¡¨.docx`, blob);
            
            // å»¶æ—¶é˜²æ­¢é€Ÿç‡é™åˆ¶
            await new Promise(r => setTimeout(r, 1200));
        }

        addLog("âœ… å…¨éƒ¨å®Œæˆï¼Œæ­£åœ¨å¯åŠ¨ä¸‹è½½...");
        saveAs(await zip.generateAsync({type:"blob"}), "è¾…å¯¼å‘˜è°ˆè¯è®°å½•åŒ….zip");
        document.getElementById('generateBtn').disabled = false;
    }
</script>
</body>
</html>