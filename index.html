<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¾…å¯¼å‘˜è°ˆè¯ç”Ÿæˆå™¨ (å¤šè®°å½•åˆå¹¶ç‰ˆ)</title>
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: "Microsoft YaHei", sans-serif; background-color: #f0f2f5; padding: 20px; display: flex; justify-content: center; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); width: 850px; }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 20px; font-size: 24px; }
        .box { background: #eef2f7; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 5px solid #3498db; }
        .api-input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; background: #e8f0fe; color: #555; font-family: monospace; }
        .file-label { display: block; background: #fff; border: 2px dashed #3498db; color: #3498db; padding: 15px; border-radius: 5px; text-align: center; cursor: pointer; transition: 0.2s; }
        .file-label:hover { background: #f0f8ff; border-color: #2980b9; }
        .btn { width: 100%; padding: 12px; background: #27ae60; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn:disabled { background: #bdc3c7; cursor: not-allowed; }
        .btn:hover:not(:disabled) { background: #219150; }
        .log-area { height: 200px; overflow-y: auto; background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 6px; font-size: 13px; margin-top: 15px; font-family: monospace; }
        .log-line { margin-bottom: 4px; border-bottom: 1px solid #3e5871; padding-bottom: 2px; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“š å­¦ç”Ÿæˆé•¿è®°å½•ç”Ÿæˆå™¨ (å¤šæ¡åˆä¸€ç‰ˆ)</h1>

    <div class="box">
        <b>âš™ï¸ æ ¸å¿ƒè®¾ç½®</b>
        <div style="margin-top:5px; font-size:12px; color:#666;">DeepSeek API Key (å·²é¢„è®¾):</div>
        <input type="password" id="apiKey" class="api-input" value="sk-ac06ce5e03ec4f13abe17ad8b42582ed">
    </div>

    <div class="box">
        <b>ğŸ“‚ å¯¼å…¥æ•°æ®</b>
        <p style="font-size:12px; color:#555; margin:5px 0;">
            Excelè¡¨å¤´éœ€åŒ…å«ï¼š<code>å§“å</code>ã€<code>ç­çº§</code>ã€<code>å­¦å·</code><br>
            è¯´æ˜ï¼šæ¯ä¸ªå­¦ç”Ÿå°†è‡ªåŠ¨ç”Ÿæˆ <b>1-5æ¡</b> è°ˆè¯è®°å½•ï¼ŒæŒ‰æ—¶é—´æ’åºåˆå¹¶åœ¨åŒä¸€ä¸ªWordä¸­ã€‚
        </p>
        <label for="uploadExcel" class="file-label" id="fileLabel">ç‚¹å‡»é€‰æ‹© Excel æ–‡ä»¶...</label>
        <input type="file" id="uploadExcel" accept=".xlsx, .xls" onchange="handleFileUpload(this)">
    </div>

    <button id="generateBtn" class="btn" onclick="startProcess()" disabled>ğŸš€ å¼€å§‹æ‰¹é‡ç”Ÿæˆ</button>

    <div class="log-area" id="logArea">ç­‰å¾…ä»»åŠ¡...</div>
</div>

<script>
    let loadedData = [];
    const API_URL = "https://api.deepseek.com/chat/completions"; 
    
    // === é…ç½®åº“ ===
    const topics = ["å­¦ä¸šé¢„è­¦", "å®¿èˆå…³ç³»", "è¯„å¥–è¯„ä¼˜", "èŒä¸šè§„åˆ’", "å¿ƒç†å…³æ€€", "å‡æœŸå»å‘", "ç­çº§å»ºè®¾", "æŸ¥è¯¾ç¼ºå‹¤", "å…¥å…šè°ˆè¯", "ç»æµèµ„åŠ©"];
    
    // ç”Ÿæˆéšæœºåœ°ç‚¹
    function getRandomLocation() {
        const ranges = [
            {floor: 1, min: 1, max: 7}, // 1-101 ~ 1-107
            {floor: 2, min: 1, max: 7}, // 1-201 ~ 1-207
            {floor: 3, min: 1, max: 7}  // 1-301 ~ 1-307
        ];
        const r = ranges[Math.floor(Math.random() * ranges.length)];
        const room = Math.floor(Math.random() * (r.max - r.min + 1)) + r.min;
        return `1-${r.floor}0${room}`;
    }

    // ç”Ÿæˆ N ä¸ªæ’åºå¥½çš„æ—¥æœŸ (è¿‡å»ä¸€å­¦æœŸ)
    function generateSortedDates(count) {
        let dates = [];
        const end = new Date().getTime();
        const start = new Date().getTime() - (150 * 24 * 60 * 60 * 1000); // è¿‡å»5ä¸ªæœˆ

        for (let i = 0; i < count; i++) {
            dates.push(new Date(start + Math.random() * (end - start)));
        }
        // æ—¶é—´æ’åºï¼šä»å°åˆ°å¤§
        dates.sort((a, b) => a - b);
        
        return dates.map(d => `${d.getFullYear()}å¹´${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥`);
    }

    function handleFileUpload(input) {
        const file = input.files[0];
        if (!file) return;
        document.getElementById('fileLabel').innerText = "âœ… å·²åŠ è½½: " + file.name;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            loadedData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            
            if (loadedData.length > 0 && loadedData[0]['å§“å']) {
                document.getElementById('generateBtn').disabled = false;
                addLog(`æˆåŠŸè¯»å– ${loadedData.length} åå­¦ç”Ÿä¿¡æ¯ã€‚`);
            } else {
                alert("è¡¨æ ¼æ ¼å¼å¯èƒ½æœ‰è¯¯ï¼Œè¯·æ£€æŸ¥æ˜¯å¦åŒ…å«'å§“å'åˆ—");
            }
        };
        reader.readAsArrayBuffer(file);
    }

    function addLog(msg) {
        const div = document.getElementById('logArea');
        div.innerHTML += `<div class="log-line">> ${msg}</div>`;
        div.scrollTop = div.scrollHeight;
    }

    // === æ ¸å¿ƒ AI æ‰¹é‡ç”Ÿæˆé€»è¾‘ ===
    async function generateRecordsByAI(apiKey, student, recordCount) {
        const name = student['å§“å'];
        const position = student['èŒåŠ¡'] || "æ— ";
        const dates = generateSortedDates(recordCount);
        
        // æ„å»ºä»»åŠ¡åˆ—è¡¨ï¼Œè®©AIä¸€æ¬¡æ€§å¤„ç†
        let tasks = [];
        for(let i=0; i<recordCount; i++) {
            tasks.push({
                index: i+1,
                date: dates[i],
                topic: topics[Math.floor(Math.random() * topics.length)],
                location: getRandomLocation(),
                includeReflection: Math.random() > 0.5 // éšæœºæ˜¯å¦åŒ…å«åæ€
            });
        }

        const prompt = `
        ä½ æ˜¯ä¸€åé«˜æ ¡è¾…å¯¼å‘˜ã€‚è¯·ä¸ºå­¦ç”Ÿ"${name}"ï¼ˆèŒåŠ¡ï¼š${position}ï¼‰ç”Ÿæˆ ${recordCount} ä»½è°ˆè¯è®°å½•ã€‚
        
        ä»»åŠ¡åˆ—è¡¨å¦‚ä¸‹ï¼ˆè¯·ä¸¥æ ¼æŒ‰é¡ºåºç”Ÿæˆï¼‰ï¼š
        ${tasks.map(t => `ç¬¬${t.index}ä»½ï¼šæ—¥æœŸ${t.date}ï¼Œäº‹ç”±${t.topic}ï¼Œ${t.includeReflection ? "éœ€è¦åæ€" : "ä¸éœ€è¦åæ€"}`).join("\n")}

        è¦æ±‚ï¼š
        1. è¿”å›ä¸€ä¸ªæ ‡å‡†çš„ JSON æ•°ç»„ã€‚
        2. æ•°ç»„ä¸­æ¯ä¸ªå¯¹è±¡åŒ…å« 4 ä¸ªå­—æ®µï¼š
           - "date" (åŸæ ·è¿”å›)
           - "topic" (åŸæ ·è¿”å›)
           - "content" (è°ˆè¯è¿‡ç¨‹)ï¼š50-150å­—ï¼Œç®€æ´çœŸå®ã€‚è‹¥å­¦ç”Ÿæœ‰èŒåŠ¡ï¼Œè¯·åœ¨å…¶ä¸­æŸä¸€æ¬¡è°ˆè¯ä¸­é€‚åº¦æåŠã€‚
           - "reflection" (åæ€)ï¼šè‹¥ä»»åŠ¡è¦æ±‚åæ€ï¼Œåˆ™å†™30-50å­—ï¼›è‹¥ä¸éœ€è¦ï¼Œåˆ™è¿”å›ç©ºå­—ç¬¦ä¸²""ã€‚
        3. ä¸è¦Markdownæ ¼å¼ï¼Œç›´æ¥è¿”å›JSONå­—ç¬¦ä¸²ã€‚
        `;

        try {
            const response = await fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
                body: JSON.stringify({
                    model: "deepseek-chat",
                    messages: [{"role": "user", "content": prompt}],
                    temperature: 1.1
                })
            });
            const json = await response.json();
            let raw = json.choices[0].message.content.replace(/```json/g, "").replace(/```/g, "").trim();
            const aiResults = JSON.parse(raw);
            
            // å°†AIç”Ÿæˆçš„å†…å®¹ä¸æˆ‘ä»¬ç”Ÿæˆçš„åœ°ç‚¹åˆå¹¶
            return aiResults.map((item, index) => ({
                ...item,
                location: tasks[index].location // ç¡®ä¿ä½¿ç”¨æˆ‘ä»¬JSç”Ÿæˆçš„éšæœºåœ°ç‚¹
            }));

        } catch (e) {
            addLog(`âš ï¸ AI ç”Ÿæˆå‡ºé”™ (${name})ï¼Œè½¬ä¸ºä½¿ç”¨å¤‡ç”¨æ¨¡æ¿ã€‚`);
            // å…œåº•ç”Ÿæˆ
            return tasks.map(t => ({
                date: t.date,
                topic: t.topic,
                location: t.location,
                content: `äº†è§£äº†${name}åœ¨${t.topic}æ–¹é¢çš„æƒ…å†µã€‚å­¦ç”Ÿæ€åº¦ç«¯æ­£ï¼Œæ²Ÿé€šé¡ºç•…ã€‚${position !== 'æ— ' ? 'è‚¯å®šäº†å…¶ä½œä¸º' + position + 'çš„å·¥ä½œè¡¨ç°ã€‚' : ''}å·²ç»™äºˆç›¸åº”çš„æŒ‡å¯¼å’Œå»ºè®®ã€‚`,
                reflection: t.includeReflection ? "è¯¥ç”Ÿè¡¨ç°ç¨³å®šï¼Œåç»­ä¿æŒå…³æ³¨ã€‚" : ""
            }));
        }
    }

    // === ä¸»æµç¨‹ ===
    async function startProcess() {
        const apiKey = document.getElementById('apiKey').value.trim();
        const btn = document.getElementById('generateBtn');
        btn.disabled = true;
        
        const zip = new JSZip();
        const { Document, Packer, Paragraph, Table, TableRow, TableCell, WidthType, HeadingLevel, AlignmentType, BorderStyle } = docx;

        for (let i = 0; i < loadedData.length; i++) {
            const student = loadedData[i];
            const name = student['å§“å'];
            // éšæœºç”Ÿæˆ 1-5 æ¬¡è®°å½•
            const recordCount = Math.floor(Math.random() * 5) + 1; 

            addLog(`[${i+1}/${loadedData.length}] æ­£åœ¨ä¸º ${name} ç”Ÿæˆ ${recordCount} æ¡è®°å½•...`);

            // è·å–å†…å®¹
            const records = await generateRecordsByAI(apiKey, student, recordCount);

            // === æ„å»º Word æ–‡æ¡£ ===
            const docChildren = [];
            
            // 1. é¡¶éƒ¨ï¼šå­¦ç”ŸåŸºç¡€ä¿¡æ¯ (åªæ˜¾ç¤ºä¸€æ¬¡)
            docChildren.push(new Paragraph({ text: "å­¦ç”Ÿæˆé•¿è¾…å¯¼è®°å½•å†Œ", heading: HeadingLevel.HEADING_1, alignment: AlignmentType.CENTER, spacing: { after: 300 } }));
            
            docChildren.push(new Table({
                width: { size: 100, type: WidthType.PERCENTAGE },
                rows: [
                    new TableRow({ children: [
                        new TableCell({ children: [new Paragraph({text: "å§“å", bold: true})], width: {size: 15, type: WidthType.PERCENTAGE} }),
                        new TableCell({ children: [new Paragraph(String(name))], width: {size: 35, type: WidthType.PERCENTAGE} }),
                        new TableCell({ children: [new Paragraph({text: "å­¦å·", bold: true})], width: {size: 15, type: WidthType.PERCENTAGE} }),
                        new TableCell({ children: [new Paragraph(String(student['å­¦å·'] || ""))], width: {size: 35, type: WidthType.PERCENTAGE} }),
                    ]}),
                    new TableRow({ children: [
                        new TableCell({ children: [new Paragraph({text: "ç­çº§", bold: true})] }),
                        new TableCell({ children: [new Paragraph(String(student['ç­çº§'] || ""))], columnSpan: 3 }),
                    ]})
                ]
            }));
            
            docChildren.push(new Paragraph({ text: "", spacing: { after: 400 } })); // ç©ºè¡Œ

            // 2. å¾ªç¯æ’å…¥æ¯ä¸€æ¡è°ˆè¯è®°å½•
            records.forEach((rec, idx) => {
                // åˆ†å‰²çº¿ (å¦‚æœæ˜¯ç¬¬ä¸€æ¡å°±ä¸åŠ )
                if (idx > 0) {
                    docChildren.push(new Paragraph({ 
                        text: "-----------------------------------------------------------------------------------------", 
                        alignment: AlignmentType.CENTER,
                        spacing: { before: 200, after: 200 } 
                    }));
                }

                // è®°å½•æ ‡é¢˜
                docChildren.push(new Paragraph({ 
                    text: `ç¬¬ ${idx + 1} æ¬¡è°ˆè¯è®°å½•`, 
                    heading: HeadingLevel.HEADING_3,
                    spacing: { after: 100 }
                }));

                // å•æ¬¡è®°å½•çš„ä¿¡æ¯è¡¨æ ¼
                docChildren.push(new Table({
                    width: { size: 100, type: WidthType.PERCENTAGE },
                    rows: [
                        new TableRow({ children: [
                            new TableCell({ children: [new Paragraph({text: "æ—¥æœŸ", bold: true})], width: {size: 15, type: WidthType.PERCENTAGE} }),
                            new TableCell({ children: [new Paragraph(rec.date)], width: {size: 35, type: WidthType.PERCENTAGE} }),
                            new TableCell({ children: [new Paragraph({text: "åœ°ç‚¹", bold: true})], width: {size: 15, type: WidthType.PERCENTAGE} }),
                            new TableCell({ children: [new Paragraph(rec.location)], width: {size: 35, type: WidthType.PERCENTAGE} }),
                        ]}),
                        new TableRow({ children: [
                            new TableCell({ children: [new Paragraph({text: "äº‹ç”±", bold: true})] }),
                            new TableCell({ children: [new Paragraph(rec.topic)], columnSpan: 3 }),
                        ]})
                    ]
                }));

                // è°ˆè¯å†…å®¹
                docChildren.push(new Paragraph({ text: "ã€è°ˆè¯å†…å®¹ã€‘", bold: true, spacing: { before: 100 } }));
                docChildren.push(new Paragraph({ text: rec.content, spacing: { line: 260 } }));

                // è¾…å¯¼å‘˜åæ€ (å¦‚æœæœ‰)
                if (rec.reflection && rec.reflection.length > 0) {
                    docChildren.push(new Paragraph({ text: "ã€è¾…å¯¼å‘˜åæ€ã€‘", bold: true, spacing: { before: 100 } }));
                    docChildren.push(new Paragraph({ text: rec.reflection, spacing: { line: 260 } }));
                }
                
                // å¢åŠ ä¸€ç‚¹é—´è·
                docChildren.push(new Paragraph({ text: "", spacing: { after: 200 } }));
            });

            const doc = new Document({
                sections: [{ children: docChildren }]
            });

            const blob = await Packer.toBlob(doc);
            zip.file(`${name}_${recordCount}æ¬¡è®°å½•.docx`, blob);
            
            // ç¨ä½œå»¶æ—¶
            await new Promise(r => setTimeout(r, 1000));
        }

        addLog("ğŸ‰ å…¨éƒ¨ç”Ÿæˆå®Œæ¯•ï¼æ­£åœ¨æ‰“åŒ…ä¸‹è½½...");
        const content = await zip.generateAsync({type:"blob"});
        saveAs(content, "å­¦ç”Ÿæˆé•¿è®°å½•(å¤šæ¡åˆä¸€).zip");
        btn.disabled = false;
    }
</script>

</body>
</html>