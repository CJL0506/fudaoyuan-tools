<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¾…å¯¼å‘˜è°ˆè¯ç”Ÿæˆå™¨ (è¿ç»­å‰§æ¨¡å¼+ç‰¹æ®Šæƒ…å†µ)</title>
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: "Segoe UI", "Microsoft YaHei", sans-serif; background-color: #f0f2f5; padding: 20px; display: flex; justify-content: center; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); width: 850px; max-width: 100%; }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 20px; font-size: 24px; }
        .box { background: #fff; border: 1px solid #e1e4e8; padding: 20px; border-radius: 8px; margin-bottom: 15px; }
        .box-title { font-weight: bold; margin-bottom: 10px; color: #2c3e50; display: block; }
        .api-input { width: 96%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; color: #333; background-color: #f8f9fa; }
        .file-label { display: block; background: #e3f2fd; border: 2px dashed #90caf9; color: #1976d2; padding: 20px; border-radius: 6px; text-align: center; cursor: pointer; transition: 0.2s; }
        .file-label:hover { background: #bbdefb; border-color: #42a5f5; }
        .btn { width: 100%; padding: 14px; background: #2e7d32; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; font-weight: bold; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn:disabled { background: #cfd8dc; cursor: not-allowed; box-shadow: none; color: #90a4ae; }
        .btn:hover:not(:disabled) { background: #1b5e20; }
        .log-area { height: 250px; overflow-y: auto; background: #263238; color: #eceff1; padding: 15px; border-radius: 6px; font-size: 13px; margin-top: 15px; font-family: Consolas, monospace; line-height: 1.5; }
        .footer { text-align: center; font-size: 12px; color: #aaa; margin-top: 20px; }
        .highlight { color: #ffeb3b; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“ å­¦ç”Ÿè°ˆè¯ç”Ÿæˆå™¨ (è¿ç»­å¯¹è¯ç‰ˆ)</h1>

    <div class="box">
        <span class="box-title">ğŸ”‘ API Key (å·²å†…ç½®)</span>
        <input type="password" id="apiKey" class="api-input" value="sk-ac06ce5e03ec4f13abe17ad8b42582ed" oninput="saveKey()">
        <div style="font-size:12px; color:#e53e3e; margin-top:5px; font-weight:bold;">
            âš ï¸ æ³¨æ„ï¼šKey å·²å†…ç½®ï¼Œè¯·å‹¿å¤–ä¼ æ–‡ä»¶ã€‚
        </div>
    </div>

    <div class="box">
        <span class="box-title">ğŸ“‚ ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡ Excel è¡¨æ ¼</span>
        <p style="font-size:13px; color:#666; margin:5px 0 10px;">
            å¿…å¡«åˆ—ï¼š<code>å§“å</code>ã€<code>ç­çº§</code>ã€<code>å­¦å·</code><br>
            <b>âœ¨ æ–°å¢åŠŸèƒ½ï¼š</b> è¯·å¢åŠ ä¸€åˆ— <code>å…¶ä»–æƒ…å†µ</code> (å¦‚: "æŒ‚ç§‘é¢„è­¦"ã€"å®¶åº­å›°éš¾"ã€"æƒ³å½“å…µ")ã€‚<br>
            å¦‚æœæœ‰å†…å®¹ï¼ŒAI ä¼šè‡ªåŠ¨å›´ç»•å®ƒç”Ÿæˆè¿ç»­çš„è·Ÿè¸ªè°ˆè¯ï¼›å¦‚æœä¸ºç©ºï¼Œåˆ™æŒ‰å¸¸è§„(èŒä¸š/å¿ƒç†)ç”Ÿæˆã€‚
        </p>
        <label for="uploadExcel" class="file-label" id="fileLabel">ç‚¹å‡»é€‰æ‹© Excel æ–‡ä»¶ (.xlsx / .xls)</label>
        <input type="file" id="uploadExcel" accept=".xlsx, .xls" onchange="handleFileUpload(this)" style="display:none;">
    </div>

    <button id="generateBtn" class="btn" onclick="startProcess()" disabled>ğŸš€ å¼€å§‹ç”Ÿæˆè¿ç»­å‰§å¼å¯¹è¯</button>

    <div class="log-area" id="logArea">ç­‰å¾…ä»»åŠ¡å¼€å§‹...</div>
</div>

<script>
    let loadedData = [];
    const API_URL = "https://api.deepseek.com/chat/completions"; 

    window.onload = function() {
        const savedKey = localStorage.getItem("deepseek_key");
        const currentKey = document.getElementById("apiKey").value;
        if(savedKey && savedKey !== currentKey) console.log("Key ready");
    }

    function saveKey() {
        const key = document.getElementById("apiKey").value.trim();
        localStorage.setItem("deepseek_key", key);
    }

    // === è¯é¢˜åº“ (ä½œä¸ºå¤‡é€‰ï¼ŒAIä¼šä¼˜å…ˆå‚è€ƒå…¶ä»–æƒ…å†µ) ===
    const baseTopics = [
        "èŒä¸šè§„åˆ’", "è€ƒç ”æŒ‡å¯¼", "å°±ä¸šæ„å‘", 
        "å¿ƒç†å…³æ€€", "äººé™…é€‚åº”", "æƒ…ç»ªè°ƒèŠ‚",
        "å‡æœŸå»å‘", "ç¤¾ä¼šå®è·µ", "ç•™æ ¡å®‰å…¨"
    ];

    function getRandomLocation() {
        const ranges = [{floor: 1, min: 1, max: 7}, {floor: 2, min: 1, max: 7}, {floor: 3, min: 1, max: 7}];
        const r = ranges[Math.floor(Math.random() * ranges.length)];
        return `1-${r.floor}0${Math.floor(Math.random() * (r.max - r.min + 1)) + r.min}`;
    }

    // ç”Ÿæˆæ—¶é—´åºåˆ—
    function generateSortedDates(count) {
        let dates = [];
        const end = new Date().getTime();
        const start = end - (160 * 24 * 60 * 60 * 1000); // è¿‡å»åŠå¹´
        for (let i = 0; i < count; i++) dates.push(new Date(start + Math.random() * (end - start)));
        return dates.sort((a, b) => a - b).map(d => `${d.getFullYear()}å¹´${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥`);
    }

    function handleFileUpload(input) {
        const file = input.files[0];
        if (!file) return;
        document.getElementById('fileLabel').innerText = "âœ… å·²åŠ è½½: " + file.name;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                loadedData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                if (loadedData.length > 0 && loadedData[0]['å§“å']) {
                    document.getElementById('generateBtn').disabled = false;
                    addLog(`è¯»å–æˆåŠŸï¼Œå…± ${loadedData.length} åå­¦ç”Ÿã€‚`);
                } else { alert("è¡¨æ ¼æ ¼å¼é”™è¯¯ï¼šç¼ºå°‘'å§“å'åˆ—"); }
            } catch(err) { alert("è¯»å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶"); }
        };
        reader.readAsArrayBuffer(file);
    }

    function addLog(msg) {
        const div = document.getElementById('logArea');
        div.innerHTML += `<div style="margin-bottom:5px; border-bottom:1px solid #37474f;">> ${msg}</div>`;
        div.scrollTop = div.scrollHeight;
    }

    // === æ ¸å¿ƒï¼šè¿ç»­å‰§ç”Ÿæˆé€»è¾‘ ===
    async function generateRecordsByAI(apiKey, student, recordCount) {
        const name = student['å§“å'];
        const dates = generateSortedDates(recordCount);
        
        // è¯»å–â€œå…¶ä»–æƒ…å†µâ€åˆ—ï¼Œå¦‚æœæ²¡å¡«åˆ™æ˜¯ç©ºå­—ç¬¦ä¸²
        const otherInfo = student['å…¶ä»–æƒ…å†µ'] || ""; 
        const hasSpecialInfo = otherInfo && otherInfo.length > 1;

        // æ„å»ºå­¦ç”Ÿç”»åƒ
        let studentProfile = JSON.stringify(student, null, 2);

        // é¢„è®¾ä»»åŠ¡ (å¦‚æœæœ‰ç‰¹æ®Šæƒ…å†µï¼Œè®©AIè‡ªå·±å®šä¸»é¢˜ï¼Œå¦åˆ™éšæœºåˆ†é…)
        let tasks = [];
        for(let i=0; i<recordCount; i++) {
            tasks.push({ 
                index: i+1, 
                date: dates[i], 
                topic: hasSpecialInfo ? "æ ¹æ®'å…¶ä»–æƒ…å†µ'å’Œä¸Šä¸‹æ–‡è‡ªåŠ¨å†³å®š" : baseTopics[Math.floor(Math.random() * baseTopics.length)], 
                location: getRandomLocation()
            });
        }

        const prompt = `
        ä½ æ˜¯ä¸€åé«˜æ ¡è¾…å¯¼å‘˜ã€‚è¯·æ ¹æ®ä»¥ä¸‹ä¿¡æ¯ï¼Œç”Ÿæˆ ${recordCount} ä»½ã€ä¸€é—®ä¸€ç­”ã€‘å¯¹è¯è®°å½•ã€‚
        
        ã€å­¦ç”Ÿç”»åƒã€‘
        ${studentProfile}
        
        ã€å…³é”®æŒ‡ä»¤ - è¿ç»­å‰§æ¨¡å¼ã€‘
        1. **å…³æ³¨"å…¶ä»–æƒ…å†µ"**ï¼š
           - å¦‚æœå­¦ç”Ÿè¡¨æ ¼é‡Œçš„ã€å…¶ä»–æƒ…å†µã€‘æœ‰å†…å®¹ï¼ˆä¾‹å¦‚"${otherInfo}"ï¼‰ï¼Œä½ **å¿…é¡»**å°†è¿™ä¸ªå†…å®¹ä½œä¸ºæ ¸å¿ƒè¯é¢˜ï¼Œç©¿æ’åœ¨å‡ æ¬¡è°ˆè¯ä¸­ã€‚
           - å¦‚æœã€å…¶ä»–æƒ…å†µã€‘ä¸ºç©ºï¼Œåˆ™ä¸»è¦å›´ç»•èŒä¸šè§„åˆ’ã€å¿ƒç†ã€å‡æœŸå±•å¼€ã€‚
        2. **ä¸Šä¸‹æ–‡å…³è”ï¼ˆTimelineï¼‰**ï¼š
           - è¿™ ${recordCount} æ¬¡è°ˆè¯æ˜¯æŒ‰æ—¶é—´é¡ºåºå‘ç”Ÿçš„ã€‚
           - **åä¸€æ¬¡è°ˆè¯å¿…é¡»åŸºäºå‰ä¸€æ¬¡çš„è¿›åº¦ï¼**
           - ä¾‹å¦‚ï¼šç¬¬1æ¬¡è°ˆè¯å»ºè®®è€ƒç ” -> ç¬¬2æ¬¡é—®å¤ä¹ è¿›åº¦ -> ç¬¬3æ¬¡èŠè€ƒå‰ç„¦è™‘ã€‚ä¸è¦å‡ºç°"å‰é¢åˆšè¯´å®Œå­¦ä¸šé¢„è­¦ï¼Œä¸‹æ¬¡çªç„¶è¯´æ‹¿äº†å›½å¥–"è¿™ç§çŸ›ç›¾ã€‚
        3. **æ ¼å¼è¦æ±‚**ï¼š
           - ä¸¥æ ¼çš„ä¸€é—®ä¸€ç­”å¯¹è¯æ ¼å¼ï¼ˆè¾…å¯¼å‘˜ï¼š... å­¦ç”Ÿï¼š...ï¼‰ã€‚
           - **ä¸è¦**ç”Ÿæˆåæ€ã€‚
           - è¿”å› JSON æ•°ç»„ï¼ŒåŒ…å«å­—æ®µ: "topic"(ç®€çŸ­ä¸»é¢˜), "content"(å¯¹è¯å…¨æ–‡æœ¬)ã€‚

        ã€æ—¶é—´å®‰æ’ã€‘
        ${tasks.map(t => `ç¬¬${t.index}æ¬¡ï¼š${t.date}`).join("\n")}
        `;

        try {
            const response = await fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
                body: JSON.stringify({ 
                    model: "deepseek-chat", 
                    messages: [{"role": "user", "content": prompt}], 
                    temperature: 1.1 
                })
            });
            const json = await response.json();
            const raw = json.choices[0].message.content.replace(/```json/g, "").replace(/```/g, "").trim();
            const aiResults = JSON.parse(raw);
            
            // åˆå¹¶ç»“æœ
            return aiResults.map((item, index) => ({ 
                ...item, 
                date: tasks[index].date,
                location: tasks[index].location
            }));

        } catch (e) {
            console.error(e);
            addLog(`âš ï¸ <span class="highlight">${name}</span> ç”Ÿæˆå¼‚å¸¸ï¼Œä½¿ç”¨å¤‡ç”¨æ•°æ®ã€‚`);
            return tasks.map(t => ({
                date: t.date, topic: "æ—¥å¸¸è°ˆå¿ƒ", location: t.location,
                content: `è¾…å¯¼å‘˜ï¼šæœ€è¿‘æ€ä¹ˆæ ·ï¼Ÿ\nå­¦ç”Ÿï¼šæŒºå¥½çš„ã€‚\nè¾…å¯¼å‘˜ï¼šé’ˆå¯¹ä½ ${otherInfo || 'è§„åˆ’'}æ–¹é¢ï¼Œæœ‰è¿›å±•å—ï¼Ÿ\nå­¦ç”Ÿï¼šè¿˜åœ¨åŠªåŠ›ã€‚`
            }));
        }
    }

    async function startProcess() {
        const apiKey = document.getElementById('apiKey').value.trim();
        if(!apiKey.startsWith("sk-")) { alert("API Key æ— æ•ˆ"); return; }
        document.getElementById('generateBtn').disabled = true;
        
        const zip = new JSZip();
        const { Document, Packer, Paragraph, Table, TableRow, TableCell, WidthType, HeadingLevel, AlignmentType, TextRun } = docx;

        for (let i = 0; i < loadedData.length; i++) {
            const student = loadedData[i];
            const name = student['å§“å'];
            // éšæœºç”Ÿæˆ 1-5 æ¬¡
            const recordCount = Math.floor(Math.random() * 5) + 1; 
            const specialInfo = student['å…¶ä»–æƒ…å†µ'] ? ` [å«ç‰¹æ®Šæƒ…å†µ: ${student['å…¶ä»–æƒ…å†µ']}]` : "";
            
            addLog(`[${i+1}/${loadedData.length}] æ­£åœ¨ç”Ÿæˆ <span class="highlight">${name}</span> çš„ ${recordCount} åœºè¿ç»­å¯¹è¯...${specialInfo}`);
            
            const records = await generateRecordsByAI(apiKey, student, recordCount);
            const docChildren = [];
            
            // æ ‡é¢˜
            docChildren.push(new Paragraph({ text: "å­¦ç”Ÿæˆé•¿è°ˆè¯è®°å½•å†Œ", heading: HeadingLevel.HEADING_1, alignment: AlignmentType.CENTER, spacing: { after: 300 } }));
            
            // åŸºç¡€ä¿¡æ¯è¡¨ (è‡ªåŠ¨è¯»å– Excel æ‰€æœ‰åˆ—)
            // è¿™é‡Œæˆ‘ä»¬æ‰‹åŠ¨æ„é€ å‰å‡ åˆ—ï¼Œç¡®ä¿æ ¼å¼å¥½çœ‹ï¼Œå…¶ä»–åˆ—æ”¾åœ¨å¤‡æ³¨é‡Œ
            const infoRows = [];
            infoRows.push(new TableRow({ children: [
                new TableCell({ children: [new Paragraph({text: "å§“å", bold: true})], width: {size: 15, type: WidthType.PERCENTAGE} }),
                new TableCell({ children: [new Paragraph(String(name))], width: {size: 35, type: WidthType.PERCENTAGE} }),
                new TableCell({ children: [new Paragraph({text: "å­¦å·", bold: true})], width: {size: 15, type: WidthType.PERCENTAGE} }),
                new TableCell({ children: [new Paragraph(String(student['å­¦å·'] || "æ— "))], width: {size: 35, type: WidthType.PERCENTAGE} }),
            ]}));
            
            // å°†"å…¶ä»–æƒ…å†µ"æ”¾å…¥è¡¨æ ¼
            infoRows.push(new TableRow({ children: [
                new TableCell({ children: [new Paragraph({text: "ç­çº§", bold: true})] }),
                new TableCell({ children: [new Paragraph(String(student['ç­çº§'] || "æ— "))] }),
                new TableCell({ children: [new Paragraph({text: "é‡è¦å¤‡æ³¨", bold: true})] }),
                new TableCell({ children: [new Paragraph(String(student['å…¶ä»–æƒ…å†µ'] || "æ— ç‰¹æ®Šè¯´æ˜"))] }), 
            ]}));

            docChildren.push(new Table({ width: { size: 100, type: WidthType.PERCENTAGE }, rows: infoRows }));
            docChildren.push(new Paragraph({ text: "", spacing: { after: 400 } }));

            // å¾ªç¯è®°å½•
            records.forEach((rec, idx) => {
                if (idx > 0) {
                    docChildren.push(new Paragraph({ 
                        text: "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”", 
                        alignment: AlignmentType.CENTER, 
                        color: "#999999",
                        spacing: { before: 200, after: 200 } 
                    }));
                }

                docChildren.push(new Paragraph({ text: `ç¬¬ ${idx + 1} æ¬¡è°ˆè¯`, heading: HeadingLevel.HEADING_3, spacing: { after: 100 } }));
                
                docChildren.push(new Table({ width: { size: 100, type: WidthType.PERCENTAGE }, rows: [
                    new TableRow({ children: [
                        new TableCell({ children: [new Paragraph({text: "æ—¥æœŸ", bold: true})], width: {size: 15, type: WidthType.PERCENTAGE} }), 
                        new TableCell({ children: [new Paragraph(rec.date)], width: {size: 35, type: WidthType.PERCENTAGE} }),
                        new TableCell({ children: [new Paragraph({text: "åœ°ç‚¹", bold: true})], width: {size: 15, type: WidthType.PERCENTAGE} }), 
                        new TableCell({ children: [new Paragraph(rec.location)], width: {size: 35, type: WidthType.PERCENTAGE} }),
                    ]}),
                    new TableRow({ children: [ 
                        new TableCell({ children: [new Paragraph({text: "è°ˆè¯ä¸»é¢˜", bold: true})] }), 
                        new TableCell({ children: [new Paragraph(rec.topic)], columnSpan: 3 }) 
                    ]})
                ]}));

                docChildren.push(new Paragraph({ text: "ã€å¯¹è¯å†…å®¹ã€‘", bold: true, spacing: { before: 100 } }));
                // å¯¹è¯å†…å®¹
                docChildren.push(new Paragraph({ text: rec.content, spacing: { line: 260 } }));
                
                docChildren.push(new Paragraph({ text: "", spacing: { after: 200 } }));
            });

            const doc = new Document({ sections: [{ children: docChildren }] });
            zip.file(`${name}_è¿ç»­å¯¹è¯è®°å½•.docx`, await Packer.toBlob(doc));
            
            await new Promise(r => setTimeout(r, 1000));
        }

        addLog("ğŸ‰ å…¨éƒ¨å®Œæˆï¼å¼€å§‹ä¸‹è½½...");
        saveAs(await zip.generateAsync({type:"blob"}), "è¿ç»­å¯¹è¯è®°å½•åŒ….zip");
        document.getElementById('generateBtn').disabled = false;
    }
</script>
</body>
</html>