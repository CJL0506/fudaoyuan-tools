<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜æ ¡è¾…å¯¼å‘˜è°ˆè¯è®°å½•ç”Ÿæˆå·¥å…· (ä¸“ç”¨ç‰ˆ)</title>
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: "Segoe UI", "Microsoft YaHei", sans-serif; background-color: #f0f2f5; padding: 20px; display: flex; justify-content: center; }
        .container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); width: 850px; max-width: 100%; }
        h1 { color: #2c3e50; text-align: center; margin-bottom: 20px; font-size: 24px; }
        .box { background: #fff; border: 1px solid #e1e4e8; padding: 20px; border-radius: 8px; margin-bottom: 15px; }
        .box-title { font-weight: bold; margin-bottom: 10px; color: #2c3e50; display: block; }
        .api-input { width: 96%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: monospace; color: #333; background-color: #f8f9fa; }
        .file-label { display: block; background: #e3f2fd; border: 2px dashed #90caf9; color: #1976d2; padding: 20px; border-radius: 6px; text-align: center; cursor: pointer; transition: 0.2s; }
        .file-label:hover { background: #bbdefb; border-color: #42a5f5; }
        .btn { width: 100%; padding: 14px; background: #2e7d32; color: white; border: none; border-radius: 6px; font-size: 16px; cursor: pointer; font-weight: bold; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn:disabled { background: #cfd8dc; cursor: not-allowed; box-shadow: none; color: #90a4ae; }
        .btn:hover:not(:disabled) { background: #1b5e20; }
        .log-area { height: 250px; overflow-y: auto; background: #263238; color: #eceff1; padding: 15px; border-radius: 6px; font-size: 13px; margin-top: 15px; font-family: Consolas, monospace; line-height: 1.5; }
        .footer { text-align: center; font-size: 12px; color: #aaa; margin-top: 20px; }
        .highlight { color: #81d4fa; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ“ å­¦ç”Ÿè°ˆè¯è®°å½•æ‰¹é‡ç”Ÿæˆå™¨ (é€»è¾‘å¢å¼ºç‰ˆ)</h1>

    <div class="box">
        <span class="box-title">ğŸ”‘ API Key (å·²å†…ç½®)</span>
        <input type="password" id="apiKey" class="api-input" value="sk-ac06ce5e03ec4f13abe17ad8b42582ed" oninput="saveKey()">
        <div style="font-size:12px; color:#e53e3e; margin-top:5px; font-weight:bold;">
            âš ï¸ æ³¨æ„ï¼šKey å·²ç›´æ¥åŒ…å«åœ¨æ–‡ä»¶ä¸­ï¼Œè¯·å‹¿å°†æ­¤æ–‡ä»¶å‘é€ç»™ä»–äººã€‚
        </div>
    </div>

    <div class="box">
        <span class="box-title">ğŸ“‚ ç¬¬ä¸€æ­¥ï¼šå‡†å¤‡ Excel è¡¨æ ¼</span>
        <p style="font-size:13px; color:#666; margin:5px 0 10px;">
            è¡¨æ ¼é¦–è¡Œå¿…é¡»åŒ…å«ï¼š<code>å§“å</code>ã€<code>ç­çº§</code>ã€<code>å­¦å·</code><br>
            <b>âœ¨ å¼ºåŠ›åŠŸèƒ½ï¼š</b> æ‚¨å¯ä»¥åœ¨è¡¨æ ¼ä¸­å¢åŠ ä»»æ„åˆ—ï¼ˆå¦‚â€œå®¶åº­æƒ…å†µâ€ã€â€œæ€§æ ¼ç‰¹ç‚¹â€ã€â€œæ„å‘åŸå¸‚â€ï¼‰ï¼ŒAI ä¼šè‡ªåŠ¨è¯»å–å¹¶æ•´åˆè¿›è°ˆè¯å†…å®¹ä¸­ï¼<br>
            * ç³»ç»Ÿå°†ä¼˜å…ˆç”Ÿæˆï¼šèŒä¸šè§„åˆ’ã€å¿ƒç†å…³æ€€ã€å‡æœŸå»å‘ã€‚
        </p>
        <label for="uploadExcel" class="file-label" id="fileLabel">ç‚¹å‡»é€‰æ‹© Excel æ–‡ä»¶ (.xlsx / .xls)</label>
        <input type="file" id="uploadExcel" accept=".xlsx, .xls" onchange="handleFileUpload(this)" style="display:none;">
    </div>

    <button id="generateBtn" class="btn" onclick="startProcess()" disabled>ğŸš€ å¼€å§‹æ™ºèƒ½ç”Ÿæˆ</button>

    <div class="log-area" id="logArea">ç­‰å¾…ä»»åŠ¡å¼€å§‹...</div>
    <div class="footer">æœ¬å·¥å…·æ‰€æœ‰æ•°æ®å¤„ç†å‡åœ¨æœ¬åœ°æµè§ˆå™¨å®Œæˆï¼Œä¸ä¼šä¸Šä¼ å­¦ç”Ÿéšç§æ•°æ®ã€‚</div>
</div>

<script>
    let loadedData = [];
    const API_URL = "https://api.deepseek.com/chat/completions"; 

    // === åˆå§‹åŒ–ï¼šæ£€æŸ¥æœ¬åœ°å­˜å‚¨ ===
    window.onload = function() {
        // å¦‚æœæœ¬åœ°æ²¡æœ‰å­˜å‚¨ï¼Œæˆ–è€…å½“å‰è¾“å…¥æ¡†æ˜¯é»˜è®¤å€¼ï¼Œå°±ä¸è¦†ç›–
        const savedKey = localStorage.getItem("deepseek_key");
        const currentKey = document.getElementById("apiKey").value;
        
        // åªæœ‰å½“æœ¬åœ°æœ‰å­˜å‚¨ä¸”ä¸ç­‰äºå½“å‰é¢„è®¾å€¼æ—¶ï¼Œæ‰è¯¢é—®æˆ–è¦†ç›–ï¼ˆè¿™é‡Œç®€åŒ–ä¸ºï¼šå¦‚æœæœ¬åœ°æœ‰ï¼Œä¼˜å…ˆç”¨æœ¬åœ°çš„ï¼Œæ–¹ä¾¿æ‚¨åç»­æ›´æ–°Keyï¼‰
        if(savedKey && savedKey !== currentKey) {
            console.log("æ£€æµ‹åˆ°æœ¬åœ°æœ‰æ—§Keyï¼Œä½†ä¼˜å…ˆä½¿ç”¨å†…ç½®Keyæˆ–ä¿æŒå½“å‰æ˜¾ç¤º");
            // document.getElementById("apiKey").value = savedKey; // å¦‚æœæ‚¨å¸Œæœ›æœ¬åœ°ç¼“å­˜ä¼˜å…ˆï¼Œå–æ¶ˆæ³¨é‡Šè¿™è¡Œ
        }
    }

    function saveKey() {
        const key = document.getElementById("apiKey").value.trim();
        localStorage.setItem("deepseek_key", key);
    }

    // === è¯é¢˜é…ç½® (åŠ æƒ) ===
    // é€šè¿‡é‡å¤æ ¸å¿ƒè¯é¢˜ï¼Œæé«˜éšæœºé€‰ä¸­çš„æ¦‚ç‡
    const weightedTopics = [
        "èŒä¸šè§„åˆ’", "èŒä¸šè§„åˆ’", "èŒä¸šè§„åˆ’", // 3x æƒé‡
        "å¿ƒç†å…³æ€€", "å¿ƒç†å…³æ€€", "å¿ƒç†å…³æ€€", // 3x æƒé‡
        "å‡æœŸå»å‘", "å‡æœŸå»å‘", "å‡æœŸå»å‘", // 3x æƒé‡
        "å®¿èˆç”Ÿæ´»", "ç¤¾ä¼šå®è·µ", "äººé™…å…³ç³»"  // 1x æƒé‡ (è¾…åŠ©è¯é¢˜)
    ];

    function getRandomLocation() {
        const ranges = [{floor: 1, min: 1, max: 7}, {floor: 2, min: 1, max: 7}, {floor: 3, min: 1, max: 7}];
        const r = ranges[Math.floor(Math.random() * ranges.length)];
        return `1-${r.floor}0${Math.floor(Math.random() * (r.max - r.min + 1)) + r.min}`;
    }

    // ç”Ÿæˆæ—¶é—´åºåˆ— (ç¡®ä¿ä¸ä¹±åº)
    function generateSortedDates(count) {
        let dates = [];
        const end = new Date().getTime();
        const start = end - (150 * 24 * 60 * 60 * 1000); // è¿‡å»5ä¸ªæœˆ
        for (let i = 0; i < count; i++) dates.push(new Date(start + Math.random() * (end - start)));
        return dates.sort((a, b) => a - b).map(d => `${d.getFullYear()}å¹´${d.getMonth() + 1}æœˆ${d.getDate()}æ—¥`);
    }

    function handleFileUpload(input) {
        const file = input.files[0];
        if (!file) return;
        document.getElementById('fileLabel').innerText = "âœ… å·²åŠ è½½: " + file.name;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                loadedData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                if (loadedData.length > 0 && loadedData[0]['å§“å']) {
                    document.getElementById('generateBtn').disabled = false;
                    addLog(`è¯»å–æˆåŠŸï¼Œå…± ${loadedData.length} åå­¦ç”Ÿã€‚`);
                } else { alert("è¡¨æ ¼æ ¼å¼é”™è¯¯ï¼šç¼ºå°‘'å§“å'åˆ—"); }
            } catch(err) { alert("è¯»å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶"); }
        };
        reader.readAsArrayBuffer(file);
    }

    function addLog(msg) {
        const div = document.getElementById('logArea');
        div.innerHTML += `<div style="margin-bottom:5px; border-bottom:1px solid #37474f;">> ${msg}</div>`;
        div.scrollTop = div.scrollHeight;
    }

    // === æ ¸å¿ƒç”Ÿæˆé€»è¾‘ ===
    async function generateRecordsByAI(apiKey, student, recordCount) {
        const name = student['å§“å'];
        const dates = generateSortedDates(recordCount);
        
        // 1. æ„å»ºå­¦ç”Ÿå…¨ç”»åƒ (å°†Excelæ‰€æœ‰åˆ—è½¬ä¸ºæ–‡æœ¬)
        let studentProfile = JSON.stringify(student, null, 2);

        // 2. é¢„è®¾ä»»åŠ¡åˆ—è¡¨
        let tasks = [];
        for(let i=0; i<recordCount; i++) {
            tasks.push({ 
                index: i+1, 
                date: dates[i], 
                topic: weightedTopics[Math.floor(Math.random() * weightedTopics.length)], 
                location: getRandomLocation(), 
                includeReflection: Math.random() > 0.4 // 60% æ¦‚ç‡æœ‰åæ€
            });
        }

        // 3. å¢å¼ºç‰ˆ Prompt
        const prompt = `
        ä½ æ˜¯ä¸€åç»éªŒä¸°å¯Œçš„é«˜æ ¡è¾…å¯¼å‘˜ã€‚è¯·æ ¹æ®ä»¥ä¸‹å­¦ç”Ÿä¿¡æ¯ï¼Œç”Ÿæˆ ${recordCount} ä»½è¿è´¯çš„è°ˆè¯è®°å½•ã€‚
        
        ã€å­¦ç”Ÿç”»åƒæ•°æ® (æ¥è‡ªExcel)ã€‘
        ${studentProfile}

        ã€ç”Ÿæˆä»»åŠ¡åˆ—è¡¨ã€‘
        ${tasks.map(t => `ç¬¬${t.index}æ¬¡ï¼š${t.date}ï¼Œä¸»é¢˜ï¼š${t.topic}ï¼Œ${t.includeReflection ? "éœ€å†™åæ€" : "ä¸å†™åæ€"}`).join("\n")}

        ã€ä¸¥æ ¼è¦æ±‚ - è¯·åŠ¡å¿…éµå®ˆã€‘
        1. **ä¸€è‡´æ€§åŸåˆ™**ï¼šè¯·å…ˆåˆ†æã€å­¦ç”Ÿç”»åƒæ•°æ®ã€‘ï¼Œä¸ºå­¦ç”Ÿç¡®ç«‹ä¸€ä¸ªåˆç†çš„äººè®¾ã€‚
           - ä¸¥ç¦å‰åçŸ›ç›¾ï¼(ä¾‹å¦‚ï¼šä¸èƒ½ç¬¬ä¸€æ¬¡è¯´å­¦ä¸šå›°éš¾ï¼Œç¬¬äºŒæ¬¡çªç„¶è¯´æ‹¿äº†å›½å®¶å¥–å­¦é‡‘)ã€‚
           - å¦‚æœè¡¨æ ¼é‡Œæœ‰ç‰¹æ®Šå¤‡æ³¨ï¼ˆå¦‚â€œè´«å›°â€ã€â€œè€ƒå…¬â€ã€â€œå¿ƒç†é¢„è­¦â€ï¼‰ï¼Œè¯·åŠ¡å¿…åœ¨è°ˆè¯å†…å®¹ä¸­èåˆè¿™äº›ä¿¡æ¯ã€‚
        2. **è¯é¢˜ä¾§é‡**ï¼šé‡ç‚¹å…³æ³¨èŒä¸šè§„åˆ’ã€å¿ƒç†å…³æ€€å’Œå‡æœŸç”Ÿæ´»ã€‚å†…å®¹è¦æ¸©æš–ã€æœ‰å»ºè®¾æ€§ï¼Œå°‘å†™å•çº¯çš„è¯´æ•™ã€‚
        3. **æ ¼å¼è¦æ±‚**ï¼š
           - è¿”å›ä¸€ä¸ªæ ‡å‡†çš„ JSON æ•°ç»„ã€‚
           - æ•°ç»„åŒ…å« ${recordCount} ä¸ªå¯¹è±¡ã€‚
           - æ¯ä¸ªå¯¹è±¡åŒ…å«å­—æ®µ: "content" (è°ˆè¯å†…å®¹, 50-150å­—), "reflection" (åæ€, 30-50å­—ï¼Œè‹¥æ— éœ€åæ€åˆ™ç•™ç©ºå­—ç¬¦ä¸²)ã€‚
           - **ä¸è¦**ä½¿ç”¨Markdownæ ¼å¼ï¼Œç›´æ¥è¿”å›çº¯JSONå­—ç¬¦ä¸²ã€‚
        `;

        try {
            const response = await fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${apiKey}` },
                body: JSON.stringify({ 
                    model: "deepseek-chat", 
                    messages: [{"role": "user", "content": prompt}], 
                    temperature: 1.0 // é™ä½ä¸€ç‚¹éšæœºæ€§ä»¥ä¿è¯é€»è¾‘è¿è´¯
                })
            });
            const json = await response.json();
            const raw = json.choices[0].message.content.replace(/```json/g, "").replace(/```/g, "").trim();
            const aiResults = JSON.parse(raw);
            
            // åˆå¹¶ AI ç»“æœä¸æœ¬åœ°ç”Ÿæˆçš„æ—¥æœŸåœ°ç‚¹
            return aiResults.map((item, index) => ({ 
                ...item, 
                date: tasks[index].date,
                topic: tasks[index].topic,
                location: tasks[index].location
            }));

        } catch (e) {
            console.error(e);
            addLog(`âš ï¸ <span class="highlight">${name}</span> ç”Ÿæˆæ—¶é‡åˆ°ç½‘ç»œæ³¢åŠ¨ï¼Œè½¬ä¸ºä½¿ç”¨å¤‡ç”¨æ¨¡æ¿ã€‚`);
            // å…œåº•é€»è¾‘
            return tasks.map(t => ({
                date: t.date, topic: t.topic, location: t.location,
                content: `è¾…å¯¼å‘˜ä¸${name}å°±${t.topic}è¿›è¡Œäº†æ·±å…¥äº¤æµã€‚ç»“åˆå­¦ç”Ÿå®é™…æƒ…å†µï¼Œç»™äºˆäº†ç›¸åº”çš„æŒ‡å¯¼å»ºè®®ã€‚å­¦ç”Ÿè¡¨ç¤ºç†è§£å¹¶ä¼šç§¯æè°ƒæ•´çŠ¶æ€ã€‚`,
                reflection: t.includeReflection ? "è¯¥ç”ŸçŠ¶æ€ç¨³å®šï¼Œå»ºè®®æŒç»­å…³æ³¨å…¶åç»­å‘å±•ã€‚" : ""
            }));
        }
    }

    async function startProcess() {
        const apiKey = document.getElementById('apiKey').value.trim();
        if(!apiKey.startsWith("sk-")) { alert("API Key æ— æ•ˆï¼Œè¯·æ£€æŸ¥è®¾ç½®"); return; }
        document.getElementById('generateBtn').disabled = true;
        
        const zip = new JSZip();
        const { Document, Packer, Paragraph, Table, TableRow, TableCell, WidthType, HeadingLevel, AlignmentType, TextRun } = docx;

        for (let i = 0; i < loadedData.length; i++) {
            const student = loadedData[i];
            const name = student['å§“å'];
            // éšæœºç”Ÿæˆ 1-5 æ¬¡è®°å½•
            const recordCount = Math.floor(Math.random() * 5) + 1; 
            
            addLog(`[${i+1}/${loadedData.length}] æ­£åœ¨ä¸º <span class="highlight">${name}</span> ç”Ÿæˆ ${recordCount} æ¡è®°å½•...`);
            
            const records = await generateRecordsByAI(apiKey, student, recordCount);
            const docChildren = [];
            
            // æ–‡æ¡£æ ‡é¢˜
            docChildren.push(new Paragraph({ text: "å­¦ç”Ÿæˆé•¿è¾…å¯¼è®°å½•å†Œ", heading: HeadingLevel.HEADING_1, alignment: AlignmentType.CENTER, spacing: { after: 300 } }));
            
            // é¡¶éƒ¨è¡¨æ ¼ï¼šè‡ªåŠ¨è¯»å– Excel ä¸­çš„æ‰€æœ‰åˆ—
            const infoRows = [];
            // å›ºå®šå±•ç¤ºï¼šå§“åã€å­¦å·
            infoRows.push(new TableRow({ children: [
                new TableCell({ children: [new Paragraph({text: "å§“å", bold: true})], width: {size: 15, type: WidthType.PERCENTAGE} }),
                new TableCell({ children: [new Paragraph(String(name))], width: {size: 35, type: WidthType.PERCENTAGE} }),
                new TableCell({ children: [new Paragraph({text: "å­¦å·", bold: true})], width: {size: 15, type: WidthType.PERCENTAGE} }),
                new TableCell({ children: [new Paragraph(String(student['å­¦å·'] || "æ— "))], width: {size: 35, type: WidthType.PERCENTAGE} }),
            ]}));
            // å›ºå®šå±•ç¤ºï¼šç­çº§ã€(èŒåŠ¡æˆ–å…¶ä»–)
            infoRows.push(new TableRow({ children: [
                new TableCell({ children: [new Paragraph({text: "ç­çº§", bold: true})] }),
                new TableCell({ children: [new Paragraph(String(student['ç­çº§'] || "æ— "))] }),
                new TableCell({ children: [new Paragraph({text: "å…¶ä»–ä¿¡æ¯", bold: true})] }),
                new TableCell({ children: [new Paragraph("è¯¦è§ç”µå­æ¡£æ¡ˆ")] }), 
            ]}));

            docChildren.push(new Table({ width: { size: 100, type: WidthType.PERCENTAGE }, rows: infoRows }));
            docChildren.push(new Paragraph({ text: "", spacing: { after: 400 } }));

            // å¾ªç¯æ’å…¥è®°å½•
            records.forEach((rec, idx) => {
                if (idx > 0) {
                    docChildren.push(new Paragraph({ 
                        text: "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”", 
                        alignment: AlignmentType.CENTER, 
                        color: "#999999",
                        spacing: { before: 200, after: 200 } 
                    }));
                }

                docChildren.push(new Paragraph({ text: `ç¬¬ ${idx + 1} æ¬¡è°ˆè¯è®°å½•`, heading: HeadingLevel.HEADING_3, spacing: { after: 100 } }));
                
                // è®°å½•å¤´ä¿¡æ¯
                docChildren.push(new Table({ width: { size: 100, type: WidthType.PERCENTAGE }, rows: [
                    new TableRow({ children: [
                        new TableCell({ children: [new Paragraph({text: "æ—¥æœŸ", bold: true})], width: {size: 15, type: WidthType.PERCENTAGE} }), 
                        new TableCell({ children: [new Paragraph(rec.date)], width: {size: 35, type: WidthType.PERCENTAGE} }),
                        new TableCell({ children: [new Paragraph({text: "åœ°ç‚¹", bold: true})], width: {size: 15, type: WidthType.PERCENTAGE} }), 
                        new TableCell({ children: [new Paragraph(rec.location)], width: {size: 35, type: WidthType.PERCENTAGE} }),
                    ]}),
                    new TableRow({ children: [ 
                        new TableCell({ children: [new Paragraph({text: "è°ˆè¯ä¸»é¢˜", bold: true})] }), 
                        new TableCell({ children: [new Paragraph(rec.topic)], columnSpan: 3 }) 
                    ]})
                ]}));

                docChildren.push(new Paragraph({ text: "ã€è°ˆè¯å†…å®¹ã€‘", bold: true, spacing: { before: 100 } }));
                docChildren.push(new Paragraph({ text: rec.content, spacing: { line: 260 } }));
                
                if (rec.reflection) {
                    docChildren.push(new Paragraph({ text: "ã€è¾…å¯¼å‘˜åæ€ã€‘", bold: true, spacing: { before: 100 } }));
                    docChildren.push(new Paragraph({ text: rec.reflection, spacing: { line: 260 } }));
                }
                
                docChildren.push(new Paragraph({ text: "", spacing: { after: 200 } }));
            });

            const doc = new Document({ sections: [{ children: docChildren }] });
            zip.file(`${name}_æˆé•¿è®°å½•.docx`, await Packer.toBlob(doc));
            
            // é€‚å½“å»¶æ—¶ï¼Œé¿å…APIå¹¶å‘è¿‡é«˜
            await new Promise(r => setTimeout(r, 1000));
        }

        addLog("ğŸ‰ å…¨éƒ¨ç”Ÿæˆå®Œæ¯•ï¼æ­£åœ¨å¯åŠ¨ä¸‹è½½...");
        saveAs(await zip.generateAsync({type:"blob"}), "è°ˆè¯è®°å½•æ‰¹é‡å¯¼å‡º.zip");
        document.getElementById('generateBtn').disabled = false;
    }
</script>
</body>
</html>